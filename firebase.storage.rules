// ============================================
// FIREBASE STORAGE SECURITY RULES
// ============================================
// Copy these to Firebase Console -> Storage -> Rules

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================
    // PROFILE IMAGES
    // ============================================
    match /users/{userId}/profile/{imageId} {
      // Users can read their own profile image
      allow read: if true; // Public profile images
      allow write: if request.auth != null
        && request.auth.uid == userId
        && imageId.matches('^[a-zA-Z0-9-_]+\\.(jpg|jpeg|png|webp)$')
        && request.resource.size < 5 * 1024 * 1024; // Max 5MB
    }

    // ============================================
    // MEDIA KITS (PDF)
    // ============================================
    match /users/{userId}/mediakit/{filename} {
      // Anyone can read media kits (for promoters to view)
      allow read: if request.auth != null;
      allow write: if request.auth != null
        && request.auth.uid == userId
        && filename.matches('^.*\\.pdf$')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }

    // ============================================
    // PROPOSAL ATTACHMENTS
    // ============================================
    match /proposals/{proposalId}/attachments/{attachmentId} {
      // Only proposal participants can read attachments
      allow read: if request.auth != null;
      
      // Only proposal participants can upload attachments
      allow write: if request.auth != null
        && attachmentId.matches('^[a-zA-Z0-9-_]+\\.(jpg|jpeg|png|webp|pdf|doc|docx)$')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }

    // ============================================
    // PROPOSAL CREATION ATTACHMENTS (before proposalId exists)
    // ============================================
    match /proposals/{allPaths} {
      // Only authenticated users can read during proposal creation
      allow read: if request.auth != null;
      allow write: if request.auth != null
        && allPaths.matches('^[0-9]+_.*\\.(jpg|jpeg|png|webp|pdf|doc|docx)$')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }

    // ============================================
    // PAYMENT PROOF SCREENSHOTS
    // ============================================
    match /proposals/{proposalId}/payments/{paymentId} {
      // Only proposal participants can read payment proofs
      allow read: if request.auth != null;
      
      // Only promoter can upload payment proof
      allow write: if request.auth != null
        && paymentId.matches('^[0-9]+_.*\\.(jpg|jpeg|png|webp)$')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }

    // ============================================
    // BRAND LOGOS (for promoters)
    // ============================================
    match /brands/{userId}/logo/{imageId} {
      // Anyone can read brand logos
      allow read: if true;
      
      // Allow write for authenticated users during signup
      // Security will be enforced at the application level
      allow write: if request.auth != null
        && request.auth.uid == userId
        && imageId.matches('^[0-9]+_.*\\.(jpg|jpeg|png|webp|svg)$')
        && request.resource.size < 5 * 1024 * 1024; // Max 5MB
    }

    // ============================================
    // PROMOTER LOGOS (alternative path)
    // ============================================
    match /users/{userId}/logo/{imageId} {
      // Anyone can read promoter logos
      allow read: if true;
      
      // Allow write for authenticated users during signup
      // Security will be enforced at the application level
      allow write: if request.auth != null
        && request.auth.uid == userId
        && imageId.matches('^[0-9]+_.*\\.(jpg|jpeg|png|webp|svg)$')
        && request.resource.size < 5 * 1024 * 1024; // Max 5MB
    }

    // ============================================
    // TASK SUBMISSION ATTACHMENTS
    // ============================================
    match /task-submissions/{submissionId}/{filename} {
      // Admins and task submitters can read
      allow read: if request.auth != null;
      
      // Only task submitters can upload (during submission)
      allow write: if request.auth != null
        && filename.matches('^.*\\.(jpg|jpeg|png|webp|pdf|doc|docx)$')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }

    // ============================================
    // CHAT ATTACHMENTS (Direct Chat & Proposal Chat)
    // ============================================
    match /messages/{conversationId}/{allPaths} {
      // Only conversation participants can read
      allow read: if request.auth != null;
      
      // Only conversation participants can send
      allow write: if request.auth != null
        && allPaths.matches('^[0-9]+_.*\\.(jpg|jpeg|png|webp|gif|pdf|doc|docx)$')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }
  }
}
